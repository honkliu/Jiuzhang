<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8" />
    <title>D3 å®¶è°±å›¾ï¼ˆç«–æ’å§“å + å¹´é¾„ï¼‰</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: "Microsoft YaHei", sans-serif;
        }

        svg {
            width: 100vw;
            height: 100vh;
            background-color: #bbbbab;
        }

        .link {
            fill: none;
            stroke: #555;
            stroke-width: 1.0px;
        }

        .node circle {
            fill: #fff;
            stroke: #000;
            stroke-width: 2px;
        }

        .name tspan {
            font-size: 16px;
            text-anchor: middle;
        }

        .age {
            font-size: 12px;
            fill: #333;
            text-anchor: middle;
        }

        .highlighted circle {
            stroke: rgb(42, 175, 71);
            stroke-width: 3px;
        }

        .highlighted text {
            fill: rgb(42, 175, 71);
            font-size: 22px;
            font-weight: bold;
        }

        .context-menu {
            font-size: 10px;
            text-anchor: middle;
        }

        .node.highlighted .tname {
            fill: rgb(42, 175, 71);
            font-size: 18px;
            font-weight: bold;
        }

        .link.highlighted {
            stroke: rgb(42, 175, 71);
            stroke-width: 2px;
        }

        /* âœ¨ éé«˜äº®éƒ¨åˆ†é€æ˜æ·¡åŒ– */
        .dimmed {
            opacity: 0.2;
        }

        #context-menu {
            position: absolute;
            display: none;
            background: #395162;
            border: 1px solid #ccc;
            padding: 10px 12px 10px 12px;
            opacity: 0.95;
            font-size: 13px;
            color: #fff;
            box-shadow: 2px 2px 6px rgba(70, 116, 85, 0.565);
            z-index: 1000;
            min-width: 180px;
            border-radius: 6px;
        }

        #context-menu input {
            width: 90px;
            margin-left: 6px;
            margin-bottom: 2px;
        }

        #context-menu button {
            margin-top: 4px;
            margin-right: 6px;
            padding: 2px 8px;
            border-radius: 4px;
            border: none;
            background: #4e7c5b;
            color: #fff;
            cursor: pointer;
        }

        #context-menu button:hover {
            background: #2aad5a;
        }

        #context-menu .menu-item {
            margin-bottom: 6px;
            cursor: pointer;
            padding: 2px 0;
        }

        #context-menu .menu-item:hover {
            background: #2aad5a;
        }

        #context-menu .label {
            margin-bottom: 4px;
            font-weight: bold;
        }

        #context-menu #child-container input {
            width: 20px;
            margin-bottom: -4px;
        }
    </style>
</head>

<body>

    <div id="context-menu" style="display: none; position: absolute;">
        <div class="menu-item">å§“åï¼š<input id="edit-name" /></div>
        <div class="menu-item">å¹´é¾„ï¼š<input id="edit-age" /></div>
        <div class="menu-item">ç”Ÿç”·ï¼š<input id="edit-boy" /></div>
        <div class="menu-item">ç”Ÿå¥³ï¼š<input id="edit-girl" /></div>
        <div class="menu-item"><button id="copy-branch">ğŸ“„ Copy æ­¤åˆ†æ”¯</button></div>
        <div class="menu-item"><button id="highlight-ancestors">ğŸ” æŸ¥çœ‹ç¥–å…ˆè·¯å¾„</button></div>

        <div id="child-container"></div>
        <template id="name-input-template">
            <div class="name-row" style="display: flex; align-items: center; gap: 0px; margin-bottom: 0px;">
                å§“åï¼š<input type="text" placeholder="å§“å" style="flex: 1" />
                <button class="add-btn">+</button>
            </div>
        </template>

        <button id="confirm-add-children">âœ… æ·»åŠ å­ä»£å¹¶åˆ·æ–°</button>
        <button id="save-node">ğŸ’¾ ä¿å­˜</button>
    </div>

    <svg></svg>
    <script>
        /*const data = {
            name: "æå¤ª", age: 102,
            children: [
                {
                    name: "ææ¾", age: 80,
                    children: [
                        {
                            name: "å¿—æ¾", age: 58,
                            children: [
                                { name: "æ­£è€•", age: 36, children: [{ name: "æœäº®", age: 12 }] },
                                { name: "æ­£è€•", age: 36, children: [{ name: "æœäº®", age: 12 }] },
                                { name: "æ­£è€•", age: 36, children: [{ name: "æœäº®", age: 12 }] },
                                { name: "æ­£è€•", age: 36, children: [{ name: "æœäº®", age: 12 }, { name: "æœäº®", age: 12 }, { name: "æœäº®", age: 12 }] },
                                { name: "æ­£å®¹", age: 34, children: [{ name: "æœå¯Œ", age: 10, children: [{ name: "æœäº®", age: 12 }] }] }
                            ]
                        },
                        {
                            name: "å¿—æ¾", age: 58,
                            children: [
                                { name: "æ­£è€•", age: 36, children: [{ name: "æœäº®", age: 12 }] },
                                { name: "æ­£è€•", age: 36, children: [{ name: "æœäº®", age: 12 }] },
                                { name: "æ­£è€•", age: 36, children: [{ name: "æœäº®", age: 12 }] },
                                { name: "æ­£è€•", age: 36, children: [{ name: "æœäº®", age: 12 }] },
                                { name: "æ­£å®¹", age: 34, children: [{ name: "æœå¯Œ", age: 10 }] }
                            ]
                        },
                        {
                            name: "å¿—æ¾", age: 58,
                            children: [
                                { name: "" }
                            ]
                        },
                        {
                            name: "å¿—æ¾", age: 58,
                            children: [
                                { name: "æ­£è€•", age: 36, children: [{ name: "æœäº®", age: 12 }] },
                                { name: "æ­£å®¹", age: 34, children: [{ name: "æœå¯Œ", age: 10 }] }
                            ]
                        }
                    ]
                }
            ]
        };
        */
    const data = {
            name: "æå‘¨æ°", age: 102,
            children: [
                {
                    name: "æå›½æ ‹", age: 80,
                    children: [
                        {
                            name: "æå¿—è¿œ", age: 58,
                            children: [
                                { name: "ææ­£è±ª", age: 36, children: [{ name: "ææœé˜³", age: 12 }] },
                                { name: "ææ­£è½©", age: 35, children: [{ name: "ææ™“é˜³", age: 11 }] },
                                { name: "ææ­£å®‡", age: 33, children: [{ name: "ææ–‡åš", age: 9 }, { name: "ææ–‡æ˜Š", age: 6 }, { name: "ææ–‡è½©", age: 4 }] },
                                { name: "ææ­£èˆª", age: 32, children: [{ name: "ææ˜Ÿè¾°", age: 8 }] },
                                { name: "æå©‰å©·", age: 30, children: [{ name: "ç‹æ€è¿œ", age: 7 }] }  // å«å…¥ç‹å®¶
                            ]
                        },
                        {
                            name: "æå¿—å®", age: 56,
                            children: [
                                { name: "ææ­£é˜³", age: 34, children: [{ name: "ææ³½å®‡", age: 10 }] },
                                { name: "ææ­£æ˜", age: 32, children: [{ name: "æé›¨è±", age: 8 }] },
                                { name: "ææ­£æ¸…", age: 30, children: [{ name: "ææ¬£æ€¡", age: 5 }] },
                                { name: "ææ­£å", age: 28, children: [{ name: "ææ˜Šç„¶", age: 3 }] },
                                { name: "æç‰ç²", age: 26, children: [] }
                            ]
                        },
                        {
                            name: "æå¿—ä¼Ÿ", age: 54,
                            children: [
                                { name: "ææµ©ç„¶", age: 29 },
                                { name: "ææ¢¦ç‘¶", age: 27, children: [{ name: "å¼ å­æ¶µ", age: 2 }] }  // å«å…¥å¼ å®¶
                            ]
                        },
                        {
                            name: "æå¿—å¼º", age: 51,
                            children: [
                                { name: "ææ­£é£", age: 28, children: [{ name: "ææ¢“æ¶µ", age: 4 }] },
                                { name: "æä½³çª", age: 25, children: [{ name: "é™ˆå®‡èˆª", age: 1 }] }  // å«å…¥é™ˆå®¶
                            ]
                        }
                    ]
                }
            ]
        };
        const svg = d3.select("svg");
        svg.on("contextmenu", event => event.preventDefault());

        const menu = document.getElementById("context-menu");

        function showContextMenu(x, y, d) {
            const menu = document.getElementById("context-menu");

            // ç»‘å®šè¾“å…¥æ¡†åˆå§‹å€¼
            document.getElementById("edit-name").value = d.data.name || "";
            document.getElementById("edit-age").value = d.data.age || 0;
            document.getElementById("edit-boy").value = "";
            document.getElementById("edit-girl").value = "";

            // æ¸…ç©ºå¹¶æ·»åŠ åˆå§‹å­è¾“å…¥æ¡†
            const container = document.getElementById("child-container");
            container.innerHTML = "";
            addNameInput(container);

            // ç»‘å®š Copy åˆ†æ”¯
            document.getElementById("copy-branch").onclick = () => {
                highlightedSet.forEach(n => console.log(n.data.name));
                hideMenu();
            };

            // ç»‘å®š é«˜äº®ç¥–å…ˆè·¯å¾„
            document.getElementById("highlight-ancestors").onclick = () => {
                highlightAncestors(d);
                hideMenu();
            };

            // ç»‘å®š æ·»åŠ å­èŠ‚ç‚¹
            document.getElementById("confirm-add-children").onclick = () => {
                const names = Array.from(container.querySelectorAll("input"))
                    .map(input => input.value.trim())
                    .filter(n => n);
                if (!d.data.children) d.data.children = [];
                names.forEach(name => d.data.children.push({ name, age: 0 }));
                hideMenu();
                updateTree();
            };

            // ç»‘å®š ä¿å­˜
            document.getElementById("save-node").onclick = () => {
                d.data.name = document.getElementById("edit-name").value;
                d.data.age = +document.getElementById("edit-age").value;
                hideMenu();
                updateTree();
            };

            // ç»‘å®šèœå•ç‚¹å‡»ä¸å†’æ³¡
            menu.onclick = e => e.stopPropagation();

            // å®šä½å¹¶æ˜¾ç¤º
            menu.style.left = `${x}px`;
            menu.style.top = `${y}px`;
            menu.style.display = "block";
        }
        // åŠ¨æ€æ·»åŠ è¾“å…¥æ¡†å‡½æ•°
        function addNameInput(container) {
            const template = document.getElementById("name-input-template");
            const clone = template.content.cloneNode(true); // å…‹éš† template å†…å®¹
            const row = clone.querySelector(".name-row");

            // ç»™è¿™ä¸ªè¡Œå†…çš„ â•æŒ‰é’®ç»‘å®šè¡Œä¸º
            row.querySelector(".add-btn").onclick = () => addNameInput(container);

            container.appendChild(clone); // æ’å…¥åˆ°å®¹å™¨ä¸­
        }

        function hideMenu() {
            menu.style.display = "none";
        }

        document.body.addEventListener("click", hideMenu);

        const width = window.innerWidth;
        const height = window.innerHeight;
        const g = svg.append("g").attr("transform", `translate(${width / 2}, 40)`);

        const root = d3.hierarchy(data);
        const tree = d3.tree().nodeSize([50, 140]);
        tree(root);

        root.eachAfter(d => {
            if (d.children && d.children.length) {
                const right = d.children[d.children.length - 1];
                d.x = right.x;
            }
        });

        function updateTree() {
            g.selectAll(".link").remove();
            g.selectAll(".node").remove();

            tree(root);
            root.eachAfter(d => {
                if (d.children && d.children.length) {
                    d.x = d.children[d.children.length - 1].x;
                }
            });

            const allNodes = root.descendants();
            const allLinks = root.links();

            // ç»˜åˆ¶è¿çº¿
            const link = g.selectAll(".link")
                .data(allLinks)
                .join("path")
                .attr("class", "link")
                .attr("d", d => `
      M${d.source.x},${d.source.y + 30}
      V${(d.source.y + d.target.y - 30) / 2}
      H${d.target.x}
      V${d.target.y - 30}
    `)
                .attr("stroke", "#555")
                .attr("stroke-opacity", 1.0)
                .attr("stroke-width", 1.0)
                .attr("stroke-linecap", "round");

            // ç»˜åˆ¶èŠ‚ç‚¹
            const node = g.selectAll(".node")
                .data(allNodes)
                .join("g")
                .attr("class", "node")
                .attr("transform", d => `translate(${d.x},${d.y})`);

            node.append("circle")
                .attr("cy", -35)
                .attr("r", 4);

            node.append("text")
                .attr("class", "name")
                .attr("y", -32)
                .selectAll("tspan")
                .data(d => d.data.name.split(""))
                .join("tspan")
                .attr("class", "tname")
                .attr("x", 0)
                .attr("dy", "1.2em")
                .text(d => d);

            node.append("text")
                .attr("class", "age")
                .attr("dy", "2.6em")
                .text(d => `å¹´é¾„ï¼š${d.data.age}`);

            // âœ¨ äº‹ä»¶ç»‘å®šï¼ˆç‚¹å‡» / å³é”®ç­‰ï¼‰
            node.on("click", (event, d) => {
                event.stopPropagation();
                highlightSubtree(d);
            });

            node.on("contextmenu", (event, d) => {
                event.preventDefault();
                event.stopPropagation();
                showContextMenu(event.pageX, event.pageY, d);
            });
        }

        const highlightedSet = new Set();
        function highlightSubtree(startNode) {
            highlightedSet.clear();
            startNode.ancestors().forEach(item => highlightedSet.add(item));
            startNode.each(d => highlightedSet.add(d));
            g.selectAll(".node").classed("highlighted", d => highlightedSet.has(d))
                .classed("dimmed", d => !highlightedSet.has(d));
            g.selectAll(".link").classed("highlighted", d => highlightedSet.has(d.target))
                .classed("dimmed", d => !highlightedSet.has(d.target));
        }

        function highlightAncestors(startNode) {
            const ancestorSet = new Set(startNode.ancestors());
            g.selectAll(".node").classed("highlighted", d => ancestorSet.has(d))
                .classed("dimmed", d => !ancestorSet.has(d));
            g.selectAll(".link").classed("highlighted", d =>
                ancestorSet.has(d.source) && ancestorSet.has(d.target))
                .classed("dimmed", d =>
                    !ancestorSet.has(d.source) || !ancestorSet.has(d.target));
        }

        svg.on("click", () => {
            g.selectAll(".node").classed("highlighted", false).classed("dimmed", false);
            g.selectAll(".link").classed("highlighted", false).classed("dimmed", false);
            highlightedSet.clear();
        });

        updateTree();
    </script>
</body>

</html>