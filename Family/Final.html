<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8" />
    <title>D3 å®¶è°±å›¾ï¼ˆç«–æ’å§“å + å¹´é¾„ï¼‰</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: "Microsoft YaHei", sans-serif;
        }

        svg {
            width: 100vw;
            height: 100vh;
            background-color: #bbbbab;
        }

        .link {
            fill: none;
            stroke: #555;
            stroke-width: 1.0px;
        }

        .node circle {
            fill: #fff;
            stroke: #000;
            stroke-width: 2px;
        }

        .name tspan {
            font-size: 16px;
            text-anchor: middle;
        }

        .spouse-text {
            font-size: 14px;
            fill: #555;
            text-anchor: middle;
        }

        .age {
            font-size: 12px;
            fill: #333;
            text-anchor: middle;
        }

        .highlighted circle {
            stroke: rgb(42, 175, 71);
            stroke-width: 3px;
        }

        .highlighted text {
            fill: rgb(42, 175, 71);
            font-size: 22px;
            font-weight: bold;
        }

        .context-menu {
            font-size: 10px;
            text-anchor: middle;
        }

        .node.highlighted .tname {
            fill: rgb(42, 175, 71);
            font-size: 18px;
            font-weight: bold;
        }

        .link.highlighted {
            stroke: rgb(42, 175, 71);
            stroke-width: 2px;
        }

        /* âœ¨ éé«˜äº®éƒ¨åˆ†é€æ˜æ·¡åŒ– */
        .dimmed {
            opacity: 0.2;
        }

        #context-menu {
            position: absolute;
            display: none;
            background: #395162;
            border: 1px solid #ccc;
            padding: 10px 12px 10px 12px;
            opacity: 0.95;
            font-size: 13px;
            color: #fff;
            box-shadow: 2px 2px 6px rgba(70, 116, 85, 0.565);
            z-index: 1000;
            min-width: 180px;
            border-radius: 6px;
        }

        #context-menu input {
            width: 90px;
            margin-left: 6px;
            margin-bottom: 2px;
        }

        #context-menu button {
            margin-top: 4px;
            margin-right: 6px;
            padding: 2px 8px;
            border-radius: 4px;
            border: none;
            background: #4e7c5b;
            color: #fff;
            cursor: pointer;
        }

        #context-menu button:hover {
            background: #2aad5a;
        }

        #context-menu .menu-item {
            margin-bottom: 6px;
            cursor: pointer;
            padding: 2px 0;
        }

        #context-menu .menu-item:hover {
            background: #2aad5a;
        }

        #context-menu .label {
            margin-bottom: 4px;
            font-weight: bold;
        }

        #context-menu #child-container input {
            width: 20px;
            margin-bottom: -4px;
        }

        #help-info {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(57, 81, 98, 0.9);
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.6;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.3);
            z-index: 999;
        }

        #help-info h4 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #2aad5a;
        }

        #help-info ul {
            margin: 0;
            padding-left: 20px;
        }
    </style>
</head>

<body>

    <div id="help-info">
        <h4>æ“ä½œè¯´æ˜</h4>
        <ul>
            <li>â†‘â†“ æˆ– æ»šè½®ï¼šä¸Šä¸‹æ»šåŠ¨ï¼ˆåˆ‡æ¢ä»£é™…å±‚çº§ï¼‰</li>
            <li>â†â†’ æˆ– Shift+æ»šè½®ï¼šå·¦å³æ»šåŠ¨ï¼ˆåˆ‡æ¢åŒä»£äººï¼‰</li>
            <li>å·¦é”®ç‚¹å‡»ï¼šé«˜äº®æ­¤äººåŠå…¶ç¥–å…ˆåä»£</li>
            <li>å³é”®ç‚¹å‡»ï¼šç¼–è¾‘èŠ‚ç‚¹ä¿¡æ¯</li>
        </ul>
    </div>

    <div id="context-menu" style="display: none; position: absolute;">
        <div class="menu-item">å§“åï¼š<input id="edit-name" /></div>
        <div class="menu-item">é…å¶ï¼š<input id="edit-spouse" /></div>
        <div class="menu-item">å¹´é¾„ï¼š<input id="edit-age" /></div>
        <div class="menu-item">ç”Ÿç”·ï¼š<input id="edit-boy" /></div>
        <div class="menu-item">ç”Ÿå¥³ï¼š<input id="edit-girl" /></div>
        <div class="menu-item"><button id="copy-branch">ğŸ“„ Copy æ­¤åˆ†æ”¯</button></div>
        <div class="menu-item"><button id="highlight-ancestors">ğŸ” æŸ¥çœ‹ç¥–å…ˆè·¯å¾„</button></div>

        <div id="child-container"></div>
        <template id="name-input-template">
            <div class="name-row" style="display: flex; align-items: center; gap: 0px; margin-bottom: 0px;">
                å§“åï¼š<input type="text" placeholder="å§“å" style="flex: 1" />
                <button class="add-btn">+</button>
            </div>
        </template>

        <button id="confirm-add-children">âœ… æ·»åŠ å­ä»£å¹¶åˆ·æ–°</button>
        <button id="save-node">ğŸ’¾ ä¿å­˜</button>
    </div>

    <svg></svg>
    <script>
        /*const data = {
            name: "æå¤ª", age: 102,
            children: [
                {
                    name: "ææ¾", age: 80,
                    children: [
                        {
                            name: "å¿—æ¾", age: 58,
                            children: [
                                { name: "æ­£è€•", age: 36, children: [{ name: "æœäº®", age: 12 }] },
                                { name: "æ­£è€•", age: 36, children: [{ name: "æœäº®", age: 12 }] },
                                { name: "æ­£è€•", age: 36, children: [{ name: "æœäº®", age: 12 }] },
                                { name: "æ­£è€•", age: 36, children: [{ name: "æœäº®", age: 12 }, { name: "æœäº®", age: 12 }, { name: "æœäº®", age: 12 }] },
                                { name: "æ­£å®¹", age: 34, children: [{ name: "æœå¯Œ", age: 10, children: [{ name: "æœäº®", age: 12 }] }] }
                            ]
                        },
                        {
                            name: "å¿—æ¾", age: 58,
                            children: [
                                { name: "æ­£è€•", age: 36, children: [{ name: "æœäº®", age: 12 }] },
                                { name: "æ­£è€•", age: 36, children: [{ name: "æœäº®", age: 12 }] },
                                { name: "æ­£è€•", age: 36, children: [{ name: "æœäº®", age: 12 }] },
                                { name: "æ­£è€•", age: 36, children: [{ name: "æœäº®", age: 12 }] },
                                { name: "æ­£å®¹", age: 34, children: [{ name: "æœå¯Œ", age: 10 }] }
                            ]
                        },
                        {
                            name: "å¿—æ¾", age: 58,
                            children: [
                                { name: "" }
                            ]
                        },
                        {
                            name: "å¿—æ¾", age: 58,
                            children: [
                                { name: "æ­£è€•", age: 36, children: [{ name: "æœäº®", age: 12 }] },
                                { name: "æ­£å®¹", age: 34, children: [{ name: "æœå¯Œ", age: 10 }] }
                            ]
                        }
                    ]
                }
            ]
        };
        */
    const data = {
            name: "æå‘¨æ°", age: 102, spouse: "æå¤ª",
            children: [
                {
                    name: "æå›½æ ‹", age: 80, spouse: "ç‹æ°",
                    children: [
                        {
                            name: "æå¿—è¿œ", age: 58, spouse: "å¼ æ°",
                            children: [
                                {
                                    name: "ææ­£è±ª", age: 36, spouse: "åˆ˜æ°",
                                    children: [
                                        {
                                            name: "ææœé˜³", age: 12, spouse: "ç‹èŠ³",
                                            children: [
                                                {
                                                    name: "æå¤©ä½‘", age: 2,
                                                    children: [
                                                        {
                                                            name: "æå®‡è½©", age: 1,
                                                            children: [
                                                                { name: "ææ˜å“²", age: 0, spouse: "èµµæ•" }
                                                            ]
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    name: "ææ­£è½©", age: 35, spouse: "é™ˆæ°",
                                    children: [
                                        {
                                            name: "ææ™“é˜³", age: 11, spouse: "å‘¨ä¸½",
                                            children: [
                                                {
                                                    name: "ææ™¨æ›¦", age: 3,
                                                    children: [
                                                        { name: "ææ‚¦æ¬£", age: 1 }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    name: "ææ­£å®‡", age: 33, spouse: "èµµæ°",
                                    children: [
                                        { name: "ææ–‡åš", age: 9, spouse: "å­™é›¨", children: [{ name: "æå­æ¶µ", age: 2, children: [{ name: "ææµ©ç„¶", age: 0 }] }] },
                                        { name: "ææ–‡æ˜Š", age: 6, children: [{ name: "æå˜‰æ€¡", age: 1 }] },
                                        { name: "ææ–‡è½©", age: 4 }
                                    ]
                                },
                                {
                                    name: "ææ­£èˆª", age: 32, spouse: "å‘¨æ°",
                                    children: [
                                        {
                                            name: "ææ˜Ÿè¾°", age: 8,
                                            children: [
                                                { name: "ææ¢¦çª", age: 2, children: [{ name: "ææ€è¿œ", age: 0 }] }
                                            ]
                                        }
                                    ]
                                },
                                { name: "æå©‰å©·", age: 30, spouse: "ç‹å¼º", children: [{ name: "ç‹æ€è¿œ", age: 7 }] }
                            ]
                        },
                        {
                            name: "æå¿—å®", age: 56, spouse: "å­™æ°",
                            children: [
                                { name: "ææ­£é˜³", age: 34, spouse: "å´æ°", children: [{ name: "ææ³½å®‡", age: 10, children: [{ name: "æä¿Šè±ª", age: 3 }] }] },
                                { name: "ææ­£æ˜", age: 32, spouse: "éƒ‘æ°", children: [{ name: "æé›¨è±", age: 8 }] },
                                { name: "ææ­£æ¸…", age: 30, spouse: "æ—æ°", children: [{ name: "ææ¬£æ€¡", age: 5 }] },
                                { name: "ææ­£å", age: 28, spouse: "é»„æ°", children: [{ name: "ææ˜Šç„¶", age: 3 }] },
                                { name: "æç‰ç²", age: 26, children: [] }
                            ]
                        },
                        {
                            name: "æå¿—ä¼Ÿ", age: 54, spouse: "é©¬æ°",
                            children: [
                                { name: "ææµ©ç„¶", age: 29, spouse: "æ—å©·", children: [{ name: "ææ™¨é˜³", age: 5, children: [{ name: "ææ˜è¿œ", age: 1 }] }] },
                                { name: "ææ¢¦ç‘¶", age: 27, spouse: "å¼ æ˜", children: [{ name: "å¼ å­æ¶µ", age: 2 }] }
                            ]
                        },
                        {
                            name: "æå¿—å¼º", age: 51, spouse: "å¾æ°",
                            children: [
                                { name: "ææ­£é£", age: 28, spouse: "ä½•æ°", children: [{ name: "ææ¢“æ¶µ", age: 4, children: [{ name: "æå˜‰è±ª", age: 1 }] }] },
                                { name: "æä½³çª", age: 25, spouse: "é™ˆä¼Ÿ", children: [{ name: "é™ˆå®‡èˆª", age: 1 }] }
                            ]
                        },
                        {
                            name: "æå¿—åˆš", age: 49, spouse: "èµµæ°",
                            children: [
                                { name: "ææ­£ä¼Ÿ", age: 26, spouse: "å´é™", children: [{ name: "æé›¨æ¶µ", age: 3 }] },
                                { name: "ææ­£å‹‡", age: 24, children: [] }
                            ]
                        }
                    ]
                },
                {
                    name: "æå›½è‰¯", age: 78, spouse: "é™ˆæ°",
                    children: [
                        {
                            name: "æå¿—å", age: 55, spouse: "æ¨æ°",
                            children: [
                                { name: "ææ­£æ–‡", age: 32, spouse: "å‘¨å©·", children: [{ name: "æå¤©èµ", age: 8 }] },
                                { name: "ææ­£æ­¦", age: 30, children: [] }
                            ]
                        }
                    ]
                }
            ]
        };
        const svg = d3.select("svg");
        svg.on("contextmenu", event => event.preventDefault());

        const menu = document.getElementById("context-menu");

        // è§†çª—ç®¡ç†å˜é‡
        let viewportStartDepth = 0; // å½“å‰æ˜¾ç¤ºçš„èµ·å§‹å±‚çº§
        const MAX_VISIBLE_DEPTH = 5; // æœ€å¤šæ˜¾ç¤º5å±‚
        let horizontalViewIndex = 0; // æ¨ªå‘è§†çª—èµ·å§‹ç´¢å¼•ï¼ˆæŒ‰æœ€å®½å±‚çš„äººæ•°è®¡ç®—ï¼‰
        const MAX_VISIBLE_WIDTH = 5; // æ¯å±‚æœ€å¤šæ˜¾ç¤º5ä¸ªèŠ‚ç‚¹

        function showContextMenu(x, y, d) {
            const menu = document.getElementById("context-menu");

            // ç»‘å®šè¾“å…¥æ¡†åˆå§‹å€¼
            document.getElementById("edit-name").value = d.data.name || "";
            document.getElementById("edit-spouse").value = d.data.spouse || "";
            document.getElementById("edit-age").value = d.data.age || 0;
            document.getElementById("edit-boy").value = "";
            document.getElementById("edit-girl").value = "";

            // æ¸…ç©ºå¹¶æ·»åŠ åˆå§‹å­è¾“å…¥æ¡†
            const container = document.getElementById("child-container");
            container.innerHTML = "";
            addNameInput(container);

            // ç»‘å®š Copy åˆ†æ”¯
            document.getElementById("copy-branch").onclick = () => {
                highlightedSet.forEach(n => console.log(n.data.name));
                hideMenu();
            };

            // ç»‘å®š é«˜äº®ç¥–å…ˆè·¯å¾„
            document.getElementById("highlight-ancestors").onclick = () => {
                highlightAncestors(d);
                hideMenu();
            };

            // ç»‘å®š æ·»åŠ å­èŠ‚ç‚¹
            document.getElementById("confirm-add-children").onclick = () => {
                const names = Array.from(container.querySelectorAll("input"))
                    .map(input => input.value.trim())
                    .filter(n => n);
                if (!d.data.children) d.data.children = [];
                names.forEach(name => d.data.children.push({ name, age: 0 }));
                hideMenu();
                updateTree();
            };

            // ç»‘å®š ä¿å­˜
            document.getElementById("save-node").onclick = () => {
                d.data.name = document.getElementById("edit-name").value;
                d.data.spouse = document.getElementById("edit-spouse").value;
                d.data.age = +document.getElementById("edit-age").value;
                hideMenu();
                updateTree();
            };

            // ç»‘å®šèœå•ç‚¹å‡»ä¸å†’æ³¡
            menu.onclick = e => e.stopPropagation();

            // å®šä½å¹¶æ˜¾ç¤º
            menu.style.left = `${x}px`;
            menu.style.top = `${y}px`;
            menu.style.display = "block";
        }
        // åŠ¨æ€æ·»åŠ è¾“å…¥æ¡†å‡½æ•°
        function addNameInput(container) {
            const template = document.getElementById("name-input-template");
            const clone = template.content.cloneNode(true); // å…‹éš† template å†…å®¹
            const row = clone.querySelector(".name-row");

            // ç»™è¿™ä¸ªè¡Œå†…çš„ â•æŒ‰é’®ç»‘å®šè¡Œä¸º
            row.querySelector(".add-btn").onclick = () => addNameInput(container);

            container.appendChild(clone); // æ’å…¥åˆ°å®¹å™¨ä¸­
        }

        function hideMenu() {
            menu.style.display = "none";
        }

        document.body.addEventListener("click", hideMenu);

        const width = window.innerWidth;
        const height = window.innerHeight;
        const g = svg.append("g");

        // å‚ç›´å’Œæ°´å¹³åç§»é‡ï¼ˆç”¨äºå¹³æ»‘æ»šåŠ¨ï¼‰
        let verticalOffset = 0;
        let horizontalOffset = 0;

        const root = d3.hierarchy(data);
        const tree = d3.tree().nodeSize([50, 140]);
        tree(root);

        root.eachAfter(d => {
            if (d.children && d.children.length) {
                const right = d.children[d.children.length - 1];
                d.x = right.x;
            }
        });

        // è®¡ç®—æ‰€æœ‰èŠ‚ç‚¹çš„Xåæ ‡èŒƒå›´
        function getXRange(nodes) {
            if (nodes.length === 0) return { min: 0, max: 0 };
            const xValues = nodes.map(n => n.x);
            return {
                min: Math.min(...xValues),
                max: Math.max(...xValues)
            };
        }

        // æŒ‰æ·±åº¦å’Œæ¨ªå‘çª—å£è¿‡æ»¤å¯è§èŠ‚ç‚¹
        function getVisibleNodes(allNodes) {
            // æŒ‰å±‚çº§åˆ†ç»„
            const nodesByDepth = {};
            allNodes.forEach(d => {
                if (!nodesByDepth[d.depth]) nodesByDepth[d.depth] = [];
                nodesByDepth[d.depth].push(d);
            });

            // æ‰¾å‡ºæœ€å®½çš„é‚£ä¸€å±‚ï¼ˆä½œä¸ºæ¨ªå‘æ»šåŠ¨çš„åŸºå‡†ï¼‰
            let widestLayerNodes = [];
            let maxWidth = 0;
            for (let depth = viewportStartDepth; depth < viewportStartDepth + MAX_VISIBLE_DEPTH; depth++) {
                if (nodesByDepth[depth] && nodesByDepth[depth].length > maxWidth) {
                    maxWidth = nodesByDepth[depth].length;
                    widestLayerNodes = nodesByDepth[depth].sort((a, b) => a.x - b.x);
                }
            }

            // å¦‚æœæœ€å®½å±‚ä¸ºç©ºï¼Œè¿”å›é»˜è®¤å€¼
            if (widestLayerNodes.length === 0) {
                return { nodes: [], centerX: 0 };
            }

            // ä»æœ€å®½å±‚ä¸­é€‰æ‹©å¯è§çš„èŠ‚ç‚¹èŒƒå›´
            const startIdx = Math.max(0, horizontalViewIndex);
            const endIdx = Math.min(widestLayerNodes.length, startIdx + MAX_VISIBLE_WIDTH);
            const visibleInWidestLayer = widestLayerNodes.slice(startIdx, endIdx);

            // è·å–å¯è§èŠ‚ç‚¹çš„Xåæ ‡èŒƒå›´
            if (visibleInWidestLayer.length === 0) {
                return { nodes: [], centerX: 0 };
            }
            const minX = Math.min(...visibleInWidestLayer.map(n => n.x));
            const maxX = Math.max(...visibleInWidestLayer.map(n => n.x));

            // åˆ›å»ºå¯è§èŠ‚ç‚¹é›†åˆ
            const visibleNodeSet = new Set();

            // æ·»åŠ æœ€å®½å±‚ä¸­å¯è§çš„èŠ‚ç‚¹
            visibleInWidestLayer.forEach(node => visibleNodeSet.add(node));

            // å¯¹äºæ·±åº¦èŒƒå›´å†…çš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œå¦‚æœåœ¨XèŒƒå›´å†…å°±æ·»åŠ 
            for (let depth = viewportStartDepth; depth < viewportStartDepth + MAX_VISIBLE_DEPTH; depth++) {
                if (nodesByDepth[depth]) {
                    nodesByDepth[depth].forEach(node => {
                        if (node.x >= minX - 50 && node.x <= maxX + 50) {
                            visibleNodeSet.add(node);
                        }
                    });
                }
            }

            // ä¸ºæ‰€æœ‰å¯è§èŠ‚ç‚¹æ·»åŠ ç¥–å…ˆ
            const nodesToAddAncestors = Array.from(visibleNodeSet);
            nodesToAddAncestors.forEach(node => {
                let ancestor = node.parent;
                while (ancestor) {
                    visibleNodeSet.add(ancestor);
                    ancestor = ancestor.parent;
                }
            });

            return {
                nodes: Array.from(visibleNodeSet),
                centerX: (minX + maxX) / 2  // è¿”å›æœ€å®½å±‚å¯è§èŠ‚ç‚¹çš„ä¸­å¿ƒ
            };
        }

        function updateTree() {
            g.selectAll(".link").remove();
            g.selectAll(".node").remove();

            tree(root);
            root.eachAfter(d => {
                if (d.children && d.children.length) {
                    d.x = d.children[d.children.length - 1].x;
                }
            });

            const allNodes = root.descendants();
            const allLinks = root.links();

            // è¿‡æ»¤å¯è§èŠ‚ç‚¹å¹¶è·å–ä¸­å¿ƒä½ç½®
            const result = getVisibleNodes(allNodes);
            const visibleNodes = result.nodes;
            const centerX = result.centerX;
            const visibleNodeSet = new Set(visibleNodes);

            // æ ¹æ®æœ€å®½å±‚å¯è§èŠ‚ç‚¹çš„ä¸­å¿ƒä½ç½®è°ƒæ•´æ°´å¹³åç§»
            horizontalOffset = -centerX;

            // è°ƒè¯•ä¿¡æ¯ï¼šæ‰“å°ç¥–å…ˆèŠ‚ç‚¹çš„åæ ‡
            const ancestorNodes = visibleNodes.filter(n => n.depth < viewportStartDepth);
            console.log(`[æ›´æ–°] index=${horizontalViewIndex}, å¯è§èŠ‚ç‚¹=${visibleNodes.length}, ç¥–å…ˆ=${ancestorNodes.length}, centerX=${centerX.toFixed(1)}, offset=${horizontalOffset.toFixed(1)}`);
            if (ancestorNodes.length > 0) {
                ancestorNodes.forEach(a => {
                    const screenX = width / 2 + horizontalOffset + a.x;
                    console.log(`  ç¥–å…ˆ ${a.data.name}: åŸå§‹X=${a.x}, å±å¹•X=${screenX.toFixed(1)}`);
                });
            }

            // ç®€åŒ–çš„è¿çº¿è¿‡æ»¤é€»è¾‘ï¼šåªè¦çˆ¶å­éƒ½åœ¨å¯è§èŠ‚ç‚¹é›†åˆä¸­ï¼Œå°±æ˜¾ç¤ºè¿çº¿
            const visibleLinks = allLinks.filter(link =>
                visibleNodeSet.has(link.source) && visibleNodeSet.has(link.target)
            );

            // æ›´æ–°å®¹å™¨ä½ç½®ï¼ˆå¸¦åŠ¨ç”»ï¼‰
            g.transition()
                .duration(300)
                .attr("transform", `translate(${width / 2 + horizontalOffset}, ${40 + verticalOffset})`);

            // ç»˜åˆ¶è¿çº¿
            const link = g.selectAll(".link")
                .data(visibleLinks)
                .join("path")
                .attr("class", "link")
                .attr("d", d => `
      M${d.source.x},${d.source.y + 30}
      V${(d.source.y + d.target.y - 30) / 2}
      H${d.target.x}
      V${d.target.y - 30}
    `)
                .attr("stroke", "#555")
                .attr("stroke-opacity", 1.0)
                .attr("stroke-width", 1.0)
                .attr("stroke-linecap", "round");

            // ç»˜åˆ¶èŠ‚ç‚¹
            const node = g.selectAll(".node")
                .data(visibleNodes)
                .join("g")
                .attr("class", "node")
                .attr("transform", d => `translate(${d.x},${d.y})`);

            node.append("circle")
                .attr("cy", -35)
                .attr("r", 4);

            // ç»˜åˆ¶ä¸»è¦å§“åï¼ˆç«–æ’ï¼‰
            node.each(function(nodeData) {
                const nameText = d3.select(this).append("text")
                    .attr("class", "name")
                    .attr("y", -32)
                    .attr("x", nodeData.data.spouse ? -15 : 0);  // å¦‚æœæœ‰é…å¶ï¼Œå·¦ç§»

                nodeData.data.name.split("").forEach((char, i) => {
                    nameText.append("tspan")
                        .attr("class", "tname")
                        .attr("x", nodeData.data.spouse ? -15 : 0)
                        .attr("dy", i === 0 ? "1.2em" : "1.2em")
                        .text(char);
                });
            });

            // ç»˜åˆ¶é…å¶å§“åï¼ˆç«–æ’ï¼Œå¹¶åˆ—æ˜¾ç¤ºï¼‰
            node.filter(d => d.data.spouse).each(function(nodeData) {
                const spouseText = d3.select(this).append("text")
                    .attr("class", "spouse-text")
                    .attr("y", -32)
                    .attr("x", 15);  // å³ç§»

                nodeData.data.spouse.split("").forEach((char, i) => {
                    spouseText.append("tspan")
                        .attr("x", 15)
                        .attr("dy", i === 0 ? "1.2em" : "1.2em")
                        .text(char);
                });
            });

            node.append("text")
                .attr("class", "age")
                .attr("dy", "2.6em")
                .text(d => `å¹´é¾„ï¼š${d.data.age}`);

            // âœ¨ äº‹ä»¶ç»‘å®šï¼ˆç‚¹å‡» / å³é”®ç­‰ï¼‰
            node.on("click", (event, d) => {
                event.stopPropagation();
                highlightSubtree(d);
            });

            node.on("contextmenu", (event, d) => {
                event.preventDefault();
                event.stopPropagation();
                showContextMenu(event.pageX, event.pageY, d);
            });
        }

        const highlightedSet = new Set();
        function highlightSubtree(startNode) {
            highlightedSet.clear();
            startNode.ancestors().forEach(item => highlightedSet.add(item));
            startNode.each(d => highlightedSet.add(d));
            g.selectAll(".node").classed("highlighted", d => highlightedSet.has(d))
                .classed("dimmed", d => !highlightedSet.has(d));
            g.selectAll(".link").classed("highlighted", d => highlightedSet.has(d.target))
                .classed("dimmed", d => !highlightedSet.has(d.target));
        }

        function highlightAncestors(startNode) {
            const ancestorSet = new Set(startNode.ancestors());
            g.selectAll(".node").classed("highlighted", d => ancestorSet.has(d))
                .classed("dimmed", d => !ancestorSet.has(d));
            g.selectAll(".link").classed("highlighted", d =>
                ancestorSet.has(d.source) && ancestorSet.has(d.target))
                .classed("dimmed", d =>
                    !ancestorSet.has(d.source) || !ancestorSet.has(d.target));
        }

        svg.on("click", () => {
            g.selectAll(".node").classed("highlighted", false).classed("dimmed", false);
            g.selectAll(".link").classed("highlighted", false).classed("dimmed", false);
            highlightedSet.clear();
        });

        // é”®ç›˜æ§åˆ¶å’Œæ»šåŠ¨
        document.addEventListener("keydown", (e) => {
            let needUpdate = false;

            // ä¸Šä¸‹æ»šåŠ¨æ§åˆ¶æ·±åº¦ - æ¯ä»£140px
            if (e.key === "ArrowUp" && viewportStartDepth > 0) {
                viewportStartDepth--;
                verticalOffset += 140;
                needUpdate = true;
            } else if (e.key === "ArrowDown") {
                const maxDepth = root.height;
                if (viewportStartDepth + MAX_VISIBLE_DEPTH <= maxDepth) {
                    viewportStartDepth++;
                    verticalOffset -= 140;
                    needUpdate = true;
                }
            }

            // å·¦å³æ»šåŠ¨æ§åˆ¶æ¨ªå‘ä½ç½® - æŒ‰ç´¢å¼•ç§»åŠ¨
            if (e.key === "ArrowLeft") {
                if (horizontalViewIndex > 0) {
                    horizontalViewIndex--;
                    needUpdate = true;
                }
            } else if (e.key === "ArrowRight") {
                // è®¡ç®—æœ€å®½å±‚çš„èŠ‚ç‚¹æ•°
                const allNodes = root.descendants();
                const nodesByDepth = {};
                allNodes.forEach(d => {
                    if (!nodesByDepth[d.depth]) nodesByDepth[d.depth] = [];
                    nodesByDepth[d.depth].push(d);
                });

                let maxWidth = 0;
                for (let depth = viewportStartDepth; depth < viewportStartDepth + MAX_VISIBLE_DEPTH; depth++) {
                    if (nodesByDepth[depth]) {
                        maxWidth = Math.max(maxWidth, nodesByDepth[depth].length);
                    }
                }

                // æ£€æŸ¥æ˜¯å¦è¿˜èƒ½å‘å³æ»šåŠ¨
                if (horizontalViewIndex + MAX_VISIBLE_WIDTH < maxWidth) {
                    horizontalViewIndex++;
                    needUpdate = true;
                }
            }

            if (needUpdate) {
                updateTree();
            }
        });

        // é¼ æ ‡æ»šè½®æ§åˆ¶ï¼ˆä¸Šä¸‹æ»šåŠ¨=æ·±åº¦ï¼ŒæŒ‰ä½Shift+æ»šè½®=æ¨ªå‘ï¼‰
        svg.on("wheel", (event) => {
            event.preventDefault();
            let needUpdate = false;

            if (event.shiftKey) {
                // æ¨ªå‘æ»šåŠ¨ - æŒ‰ç´¢å¼•ç§»åŠ¨
                if (event.deltaY < 0) {
                    // å‘å·¦æ»šåŠ¨
                    if (horizontalViewIndex > 0) {
                        horizontalViewIndex--;
                        needUpdate = true;
                    }
                } else if (event.deltaY > 0) {
                    // å‘å³æ»šåŠ¨
                    const allNodes = root.descendants();
                    const nodesByDepth = {};
                    allNodes.forEach(d => {
                        if (!nodesByDepth[d.depth]) nodesByDepth[d.depth] = [];
                        nodesByDepth[d.depth].push(d);
                    });

                    let maxWidth = 0;
                    for (let depth = viewportStartDepth; depth < viewportStartDepth + MAX_VISIBLE_DEPTH; depth++) {
                        if (nodesByDepth[depth]) {
                            maxWidth = Math.max(maxWidth, nodesByDepth[depth].length);
                        }
                    }

                    if (horizontalViewIndex + MAX_VISIBLE_WIDTH < maxWidth) {
                        horizontalViewIndex++;
                        needUpdate = true;
                    }
                }
            } else {
                // çºµå‘æ»šåŠ¨ï¼ˆæ·±åº¦ï¼‰- æ¯ä»£140px
                if (event.deltaY < 0 && viewportStartDepth > 0) {
                    viewportStartDepth--;
                    verticalOffset += 140;
                    needUpdate = true;
                } else if (event.deltaY > 0) {
                    const maxDepth = root.height;
                    if (viewportStartDepth + MAX_VISIBLE_DEPTH <= maxDepth) {
                        viewportStartDepth++;
                        verticalOffset -= 140;
                        needUpdate = true;
                    }
                }
            }

            if (needUpdate) {
                updateTree();
            }
        });

        updateTree();
    </script>
</body>

</html>